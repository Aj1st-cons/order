<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit User Details</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
        }
        button {
  background: #009500;
  color: white;
  border: none;
  cursor: pointer;
  font-weight: bold;
  padding: 10px 20px;
  border-radius: 20px; 
  white-space: nowrap;
  width: auto;
  display: block;
  margin: 10px auto;
  font-size: 16px;
        }
        .error {
            color: red;
            font-size: 0.9em;
        }
        .success {
            color: green;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>Submit Your Details</h1>
    <input type="text" id="firstName" placeholder="First Name"><br>
    <input type="text" id="lastName" placeholder="Last Name"><br>

    <div style="display: flex; flex-direction: column; gap: 5px;">
        <div style="display: flex; align-items: center;">
            <input type="text" id="reffCode" placeholder="REFF-Code click to validate" name="refCode">
            <button style="margin-bottom:-5px; padding:10px 15px;" type="button" id="validate">Validate</button>
        </div>
        <!-- Validation message container -->
        <div id="reffCodeMsg" class="error"></div>
    </div>

    <input type="text" id="storeName" placeholder="Store Name"><br>
    <input type="text" id="category" placeholder="Store Category"><br>
    <input type="text" id="address" placeholder="Store Address"><br>
    
<!--  -->
  <div style="display: flex; flex-direction: column; gap: 5px;">
  <div style="display: flex; align-items: center;">
    <input type="text" id="storeLocation" placeholder="Click 'Get' to get location" name="storeLocation"/>
    <button style="margin-bottom:-5px; padding:10px 15px;" type="button" id="getLocationButton">Get</button>
  </div></div>

  <div id="timer" class="countdown"></div>
<!--  -->
    
    <input type="email" id="email" placeholder="Email"><br>    
    <input type="number" id="contact" placeholder="Contact Number"><br>
    
    <p id="error-message" class="error"></p>
    
    <button onclick="submitUser()">Submit</button>
    
    <div id="successMessage" style="margin-top:20px; margin-bottom:50px;"></div>

    <script>
    const socket = io("https://dust-fantasy-pail.glitch.me"); // Connect to your server
    let isReffCodeValid = false;
    let isLocationRetrieved = false; // Flag to track location retrieval

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(String(email).toLowerCase());
    }

    document.getElementById('validate').addEventListener('click', function() {
        const reffCode = document.getElementById('reffCode').value.trim();
        const reffCodeMsg = document.getElementById('reffCodeMsg');

        if (!reffCode) {
            reffCodeMsg.textContent = "REFF-Code is required.";
            reffCodeMsg.className = "error";
            isReffCodeValid = false;
            return;
        }

        fetch('https://dust-fantasy-pail.glitch.me/data')
            .then(response => response.json())
            .then(data => {
                const matched = data.some(row => row.reffCode === reffCode);
                if (matched) {
                    reffCodeMsg.textContent = "REFF-Code matched!";
                    reffCodeMsg.className = "success";
                    isReffCodeValid = true;
                } else {
                    reffCodeMsg.textContent = "REFF-Code not matched.";
                    reffCodeMsg.className = "error";
                    isReffCodeValid = false;
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                reffCodeMsg.textContent = "Error validating REFF-Code.";
                reffCodeMsg.className = "error";
                isReffCodeValid = false;
            });
    });

    function submitUser() {
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const reffCode = document.getElementById('reffCode').value.trim();
        const storeName = document.getElementById('storeName').value.trim();
        const category = document.getElementById('category').value.trim();
        const address = document.getElementById('address').value.trim();
        const location = document.getElementById('storeLocation').value.trim();
        const email = document.getElementById('email').value.trim();
        const contact = document.getElementById('contact').value.trim();
        const errorMessage = document.getElementById('error-message');

        if (!firstName || !lastName || !reffCode || !storeName || !category || !address || !location || !email || !contact) {
            errorMessage.textContent = "All fields are required.";
            return;
        }

        if (!validateEmail(email)) {
            errorMessage.textContent = "Invalid email format.";
            return;
        }

        if (!isReffCodeValid) {
            errorMessage.textContent = "Please validate the REFF-Code.";
            return;
        }

        if (!isLocationRetrieved) {
            errorMessage.textContent = "Location not retrieved.";
            return;
        }

        errorMessage.textContent = ""; // Clear error message if all validations pass

        const userData = { firstName, lastName, reffCode, storeName, category, address, storeLocation: location, email, contact };

        socket.emit('submitUser', userData); // Send data to server

        // Clear form after submission
        document.querySelectorAll("input").forEach(input => input.value = "");

        // Show success message
        const successMessage = document.createElement('div');
        successMessage.textContent = "Thank you. Your details have been submitted.";
        successMessage.style.color = "#009500"; // Green color
        successMessage.style.fontWeight = "bold"; // Make the text bold

        const messageContainer = document.getElementById('successMessage');
        messageContainer.innerHTML = ''; // Clear previous messages
        messageContainer.appendChild(successMessage);

        isLocationRetrieved = false; // Reset location flag for next submission
    }

    //----------------------------------

    // Location button handler
    document.getElementById('getLocationButton').addEventListener('click', function () {
        const button = document.getElementById('getLocationButton');
        button.disabled = true;
        let countdown = 30;
        const timerElement = document.getElementById('timer');
        isLocationRetrieved = false; // Reset location flag

        // Start countdown timer
        const countdownInterval = setInterval(function () {
            countdown--;
            timerElement.textContent = `Please wait... ${countdown}s remaining`;

            if (countdown <= 0) {
                clearInterval(countdownInterval);
                timerElement.textContent = 'Time out! Location not received.';
                timerElement.style.color = '#B83C08';
                button.disabled = false;
            }
        }, 1000);

        // Request location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                const storeName = document.getElementById('storeName').value.trim().replace(/\s+/g, '');
                const category = document.getElementById('category').value.trim();

                if (storeName && category) {
                    const locationData = `"${storeName}": { lat: ${lat}, lng: ${lng}, categories: ["${category}"] }`;
                    document.getElementById('storeLocation').value = locationData;
                    isLocationRetrieved = true; // Set flag to true

                    clearInterval(countdownInterval);
                    timerElement.textContent = 'Thank you! Your location has been saved.';
                    timerElement.style.color = 'green';
                } else {
                    clearInterval(countdownInterval);
                    timerElement.textContent = 'Please fill in both store name and category.';
                    timerElement.style.color = 'red';
                    button.disabled = false;
                }
            }, function (error) {
                console.error(error);
                clearInterval(countdownInterval);
                timerElement.textContent = 'Location unavailable. Turn it ON.';
                timerElement.style.color = '#B83C08';
                button.disabled = false;
            });
        } else {
            clearInterval(countdownInterval);
            timerElement.textContent = 'Geolocation is not supported by this browser.';
            button.disabled = false;
        }
    });
</script>
</body>
</html>
