<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit User Details</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        input {
            width: 80%;
            padding: 10px;
            margin: 5px 0;
        }
        .error {
            color: red;
            font-size: 14px;
            margin-top: -5px;
        }
        .success {
            color: green;
            font-size: 14px;
            margin-top: -5px;
        }
        button {
            padding: 10px;
            background-color: #009500;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        #message {
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    
    <div id="loginContainer">
        <h1>Vendor Registration</h1>    
        
        <input type="text" id="userId" placeholder="User ID" name="User ID" required />
        <div id="userIdError" class="error"></div>
        
        <input type="text" id="vendorsCode" placeholder="Vendor-Code" name="VendorsCode" required />
        <div id="vendorsCodeError" class="error"></div>
        
        <button id="loginBtn" style="margin-bottom:50px;">Login</button><br>
        
        <button id="addShopBtn" style="border-radius:5px;">Add your Shop</button>
    </div> 

    <form id="vendorForm" style="display:none;">
        <h1>Submit Your Details</h1>

        <input type="text" id="firstName" placeholder="First Name">
        <div class="error" id="firstNameError"></div>

        <input type="text" id="lastName" placeholder="Last Name">
        <div class="error" id="lastNameError"></div>

        <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
            <div style="display: flex; align-items: center; width:87%;">
                <input type="text" id="refCode" placeholder="REFF-Code click to validate">
                <button type="button" id="validate" style="margin-top:0px;">Validate</button>
            </div>
            <div class="error" id="refCodeError"></div>
            <div id="reffCodeMsg"></div>
        </div>                      

        <input type="text" id="storeName" placeholder="Store Name">
        <div class="error" id="storeNameError"></div>

        <input type="text" id="storeCategory" placeholder="Store Category">
        <div class="error" id="storeCategoryError"></div>

        <input type="text" id="storeAddress" placeholder="Store Address">
        <div class="error" id="storeAddressError"></div>  
        
        <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
            <div style="display: flex; align-items: center; width:87%;">
                <input type="text" id="location" placeholder="Click 'Get' to get location" disabled/>
                <button type="button" id="getLocationButton" style="margin-top:0px;">Get</button>
            </div>
        </div>
        <div class="error" id="locationError"></div>

        <input type="email" id="email" placeholder="Email">
        <div class="error" id="emailError"></div>

        <input type="number" id="contact" placeholder="Contact Number">
        <div class="error" id="contactError"></div>
        <input type="text" id="vendorCode" placeholder="Vendor's Code">
        <div class="error" id="vendorCodeError"></div>

        <button type="button" onclick="submitUser()">Submit</button>
        <div id="message"></div>
    </form>
<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
    <div style="display:non;">
    <h2>Submitted Users</h2>
    <table border="1" width="80%" style="margin: auto; border-collapse: collapse;">
        <thead>
            <tr style="background: #009500; color: white; font-weight: bold;">
                <th>First Name</th>
                <th>Last Name</th>
                <th>Referrer Code</th>
                <th>Store Name</th>
                <th>Store Category</th>
                <th>Store Address</th>
                <th>Location</th>
                <th>Email</th>
                <th>Contact</th>
                <th>Vendor Code</th>
            </tr>
        </thead>
        <tbody id="userTable"></tbody>
    </table>
    </div>
<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
    <script>  
        //open vendorForm
        
document.addEventListener("DOMContentLoaded", function () {
  const addShopButton = document.getElementById("addShopBtn");
  const loginContainer = document.getElementById("loginContainer");
  const vendorForm = document.getElementById("vendorForm");

  addShopButton.addEventListener("click", function () {
    // Hide the login container
    loginContainer.style.display = "none";
    // Show the contact form
    vendorForm.style.display = "block";
  });
});                
        
//-------------------------------------------         
              
document.addEventListener("DOMContentLoaded", function () {
    const socket = io("https://dust-fantasy-pail.glitch.me");

    let refCodeValidated = false;
    let locationReceived = false;

    // Validate RefCode
    document.getElementById("validate").addEventListener("click", function () {
        const refCode = document.getElementById("refCode").value.trim();
        const refCodeError = document.getElementById("refCodeError");
        const reffCodeMsg = document.getElementById("reffCodeMsg");

        if (!refCode) {
            refCodeError.innerText = "Referrer Code is required.";
            reffCodeMsg.innerText = "";
            refCodeValidated = false;
            return;
        }

        refCodeError.innerText = ""; // Clear previous error

        fetch("https://dust-fantasy-pail.glitch.me/data")
            .then(response => response.json())
            .then(data => {
                const isValid = data.some(user => user.refCode === refCode);
                if (isValid) {
                    reffCodeMsg.innerText = "Validated";
                    reffCodeMsg.style.color = "green";
                    refCodeValidated = true;
                } else {
                    reffCodeMsg.innerText = "REFF Code not matched";
                    reffCodeMsg.style.color = "red";
                    refCodeValidated = false;
                }
            })
            .catch(error => {
                console.error("Error fetching refCode data:", error);
                reffCodeMsg.innerText = "Error checking REFF Code.";
                reffCodeMsg.style.color = "red";
                refCodeValidated = false;
            });
    });

    // Get Location
    document.getElementById("getLocationButton").addEventListener("click", function () {
        const storeName = document.getElementById("storeName").value.trim();
        const storeCategory = document.getElementById("storeCategory").value.trim();
        const locationError = document.getElementById("locationError");

        if (!storeName) {
            locationError.innerText = "Store Name is required.";
            return;
        }
        if (!storeCategory) {
            locationError.innerText = "Store Category is required.";
            return;
        }

        locationError.innerText = ""; // Clear previous errors

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const locationData = `"${storeName}": { lat: ${lat}, lng: ${lng}, categories: ["${storeCategory}"] }`;
                    document.getElementById("location").value = locationData;
                    locationError.innerText = "Location received";
                    locationError.style.color = "green";
                    locationReceived = true;
                },
                function () {
                    locationError.innerText = "Failed to get location. Please enable GPS.";
                    locationError.style.color = "red";
                    locationReceived = false;
                }
            );
        } else {
            locationError.innerText = "Geolocation is not supported in this browser.";
            locationError.style.color = "red";
            locationReceived = false;
        }
    });

    // Validate Email
    function validateEmail() {
        const email = document.getElementById("email").value.trim();
        const emailError = document.getElementById("emailError");
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!email) {
            emailError.innerText = "Email is required.";
            return false;
        } else if (!regex.test(email)) {
            emailError.innerText = "Invalid email format.";
            return false;
        } else {
            emailError.innerText = "";
            return true;
        }
    }

    // Validate Contact
    function validateContact() {
        const contact = document.getElementById("contact").value.trim();
        const contactError = document.getElementById("contactError");

        if (!contact) {
            contactError.innerText = "Contact Number is required.";
            return false;
        } else if (contact.length < 8 || contact.length > 15) {
            contactError.innerText = "Invalid contact number.";
            return false;
        } else {
            contactError.innerText = "";
            return true;
        }
    }

    // Validate Input Fields
    function validateInput(id, errorId, message) {
        const input = document.getElementById(id).value.trim();
        const errorElement = document.getElementById(errorId);

        if (!input) {
            errorElement.innerText = message;
            return false;
        } else {
            errorElement.innerText = "";
            return true;
        }
    }

    // Submit Form
    function submitUser() {
        const isValid = [
            validateInput("firstName", "firstNameError", "First Name is required."),
            validateInput("lastName", "lastNameError", "Last Name is required."),
            validateInput("storeName", "storeNameError", "Store Name is required."),
            validateInput("storeCategory", "storeCategoryError", "Store Category is required."),
            validateInput("storeAddress", "storeAddressError", "Store Address is required."),
            validateEmail(), 
            validateContact(),                      
            validateInput("vendorCode", "vendorCodeError", "Vendor Code is required.")
        ];

        const message = document.getElementById("message");

        if (isValid.includes(false)) {
            message.innerHTML = "<span style='color: red;'>Please correct the errors above.</span>";
            return;
        }

        if (!refCodeValidated) {
            document.getElementById("refCodeError").innerText = "Referrer Code must be validated.";
            return;
        }

        if (!locationReceived) {
            document.getElementById("locationError").innerText = "Location must be received.";
            return;
        }

        const userData = {
            firstName: document.getElementById("firstName").value.trim(),
            lastName: document.getElementById("lastName").value.trim(),
            refCode: document.getElementById("refCode").value.trim(),
            storeName: document.getElementById("storeName").value.trim(),
            storeCategory: document.getElementById("storeCategory").value.trim(),
            storeAddress: document.getElementById("storeAddress").value.trim(),
            location: document.getElementById("location").value.trim(),
            email: document.getElementById("email").value.trim(),
            contact: document.getElementById("contact").value.trim(),
            vendorCode: document.getElementById("vendorCode").value.trim()
        };

        socket.emit("submitUser", userData);

        document.getElementById("vendorForm").reset();
        refCodeValidated = false;
        locationReceived = false;
        document.getElementById("reffCodeMsg").innerText = "";
        document.getElementById("locationError").innerText = "";

        message.innerHTML = "<span style='color: green;'>User details submitted successfully!</span>";
    }

    document.querySelector("button[onclick='submitUser()']").addEventListener("click", submitUser);
});

//---------------------------------------

        function loadUsers() {
            fetch('https://dust-fantasy-pail.glitch.me/data')
                .then(response => response.json())
                .then(data => {
                    const table = document.getElementById('userTable');
                    table.innerHTML = "";

                    data.forEach(user => {
                        let row = `<tr>
           <td>${user.firstName}</td>
           <td>${user.lastName}</td>
           <td>${user.refCode}</td>
           <td>${user.storeName}</td>
           <td>${user.storeCategory}</td>
           <td>${user.storeAddress}</td>
           <td>${user.location}</td>
           <td>${user.email}</td>
           <td>${user.contact}</td>
           <td>${user.vendorCode}</td>
                        </tr>`;
                        table.innerHTML += row;
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        loadUsers();
        socket.on('update', loadUsers);
//---------------------------------------
</script>

</body>
</html>
